#!/usr/bin/env bash

shopt -s checkwinsize
IFS=$'\n' read -t 0.01 -d "" -ra items

trap '{
	printf "\e8" > /dev/tty
	[[ -n $output ]] && printf "%s\n" "$output"
}' EXIT

printf '\e7' > /dev/tty
while true; do
	unset matches length max_items
	for i in "${!items[@]}"; do
		[[ ${items[i]} == *"$text"* ]] && {
			matches+=("${items[i]}")
			(( ${#items[i]} > longest )) && longest=${#items[i]}
		}
	done

	(( length += longest + 5 ))

	(:)
	printf '\e[H\e[30;41m %s%*s\e[m\e[;%sH' \
		"$text" \
		$(( COLUMNS - ${#text} - 1)) "" \
		$(( longest + 6 ))

	for i in "${!matches[@]}"; do
		if (( length < COLUMNS - ${#matches[i]} - 7 )); then
			(( length += ${#matches[i]} + 2 ))
			(( max_items++ ))
		else
			printf '\e[30;41m%*s\n\e[m' "7" ">"
			break
		fi

		if (( i == sel )); then
			printf '\e[1;37;7m %s \e[m' "${matches[i]}"
		else
			printf '\e[30;41m %s \e[m' "${matches[i]}"
		fi
	done

	printf '\e[;%sH' $(( ${#text} + 2 ))

	read -srn 1
	if [[ $REPLY == $'\e' ]]; then
		read -rsn 2 key
		[[ ${REPLY}${key} == $'\e\e['* ]] &&
			read -rsn 1 _
		key=${REPLY}${key}
	else
		key=$REPLY
	fi

	case $key in
		"" | $'\r')
			printf '\e8'
			if (( ${#matches[@]} )); then
				output=${matches[sel]}
			else
				output=$text
			fi
			printf '\e7'
			break
			;;
		$'\e[D' | $'\e[A')
			(( sel > 0 && sel-- ))
			;;
		$'\e[C' | $'\e[B')
			((
				sel < ${#matches[@]} - 1 &&
				sel < max_items &&
				sel++ &&
				sel == max_items &&
				starting = max_items &&
				sel = 0
			))
			fi
			;;
		$'\177' | $'\b')
			(( ${#text} > 0 )) && {
				text=${text:: -1}
				sel=0
			}
			;;
		*)
			text+=$key
			sel=0
			;;
	esac
done < /dev/tty > /dev/tty
