#!/usr/bin/env bash

#set -- $(< /dev/stdin)
#mapfile -t items < /dev/stdin
IFS=$'\n' read -d "" -ra items < /dev/stdin
#for index in "${!items[@]}"; do
#	(( ${#items[index]} > length )) && length="${#items[index]}"
#	:
#done
#matches=("${items[@]}")

trap "printf '\e8'" EXIT
read -r LINES COLUMNS < <(stty size -F /dev/tty)
printf '\e7'
while true; do

	unset matches
	for i in "${!items[@]}"; do
		[[ ${items[i]} == *"${text// }"* ]] && {
			matches+=("${items[i]}")
			(( ${#items[i]} > length )) && length=${#items[i]}
		}
	done

	printf '\e[H\e[30;41m %s%*s\e[m\e[;%sH' \
		"$text" \
		$(( COLUMNS - ${#text} - 1)) "" \
		$(( length + 6 ))

	for i in "${!matches[@]}"; do
		#echo "${items[j]}"
		if (( i == sel )); then
			printf '\e[1;37;7m %s \e[m' "${matches[i]}"
		else
			printf '\e[30;41m %s \e[m' "${matches[i]}"
		fi
		#printf '\e[1;'
	done

	printf '\e[;%sH' $(( ${#text} + 2 ))

	read -srn 1
	if [[ $REPLY == $'\e' ]]; then
		read -rsn 2 key
		[[ ${REPLY}${key} == $'\e\e['* ]] &&
			read -rs -n 1 _
		key=${REPLY}${key}
	else
		key=$REPLY
	fi

	case $key in
		"")
			printf '\e8'
			if (( ${#matches[@]} )); then
				printf '%s\n' "${matches[sel]}"
			else
				printf '%s\n' "$text"
			fi
			printf '\e7'
			exit
			;;
		$'\e[D')
			(( sel > 0 )) && (( sel-- ))
			;;
		$'\e[C')
			(( sel < ${#matches[@]} - 1 )) && (( sel++ ))
			;;
		$'\177'|$'\b')
			(( ${#text} > 0 )) && text=${text:: -1}
			sel=0
			;;
		*)
			text+=$key
			sel=0
			;;
	esac

done < /dev/tty
