#!/usr/bin/env bash

#set -- $(< /dev/stdin)
mapfile -t items < /dev/stdin
#IFS=$'\n' read -ra items < /dev/stdin
for index in "${!items[@]}"; do
	(( ${#item[index]} > length )) && length="${#item[index]}"
done
#matches=("${items[@]}")

trap "printf '\e8'" EXIT
read -r LINES COLUMNS < <(stty size -F /dev/tty)
i=1
printf '\e7'
while true; do
	printf '\e[H\e[30;41m%*s\e[m' "$COLUMNS"
	unset matches
	for j in "${!items[@]}"; do
		[[ ${items[j]} == *$abc* ]] && {
			matches+=(${items[j]})
			((${#items[j]}>length)) && length=${#items[j]}
		}
	done

	#printf '\r\033[2K'
	printf '\e[H\e[30;41m%s%*s\e[m' " $abc" "$(( length + 4 - ${#abc} ))"
	#printf '\e[30;41m%*s\e[m' "$((length+4-${#abc}))"
	for j in "${!matches[@]}"; do
		#echo "${items[j]}"
		if (( j == i - 1 )); then
			printf '\e[1;37;7m %s \e[m' "${matches[j]}"
			selected=${matches[j]}
		else
			printf '\e[30;41m %s \e[m' "${matches[j]}"
			#printf ' %s '
		fi
		#printf '\e[1;'
	done
	((${#matches[@]})) || selected=$abc
	printf '\e[;%sH' "$((${#abc}+2))"
	read -srn 1
	if [[ $REPLY == $'\e' ]]; then
		read -rsn 2 key
		[[ ${REPLY}${key} == $'\e\e['* ]] &&
			read -rs -n 1 _
		key=${REPLY}${key}
	else
		key=$REPLY
	fi
	case $key in
		"")
			printf '\e8'
			printf '%s\n' "$selected"
			printf '\e7'
			exit
			;;
		$'\e[D')
			((i>1)) && ((i--))
			;;
		$'\e[C')
			((i<${#matches[@]})) && ((i++))
			;;
		$'\177'|$'\b')
			((${#abc}>0)) && abc=${abc:: -1}
			i=1
			;;
		*)
			abc+=$key
			i=1
			;;
	esac

done < /dev/tty
